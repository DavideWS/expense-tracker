<!DOCTYPE html>
<html>
<head>
  <title>Create Google Sheet</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
  <h1>Create a Google Sheet</h1>
  <button onclick="handleAuthClick()">Sign In & Create Sheet</button>
  <div id="output"></div>
  <div id="expense-form" style="display: none;">
    <h3>Add Expense</h3>
    <form id="add-expense-form">
      <label>Date: <input type="date" name="date" required></label><br>
      <label>Name: <input type="text" name="name" required></label><br>
  
      <label>Category:
        <select name="category" required>
          <option value="insurance">Insurance</option>
          <option value="school">School</option>
          <option value="dorm">Dorm</option>
          <option value="food">Food</option>
          <option value="internet">Internet</option>
          <option value="transportation">Transportation</option>
          <option value="entertainment">Entertainment</option>
          <option value="groceries">Groceries</option>
          <option value="other">Other</option>
        </select>
      </label><br>
  
      <label>Currency:
        <select name="currency" required>
          <option value="CAD">CAD</option>
          <option value="IDR">IDR</option>
        </select>
      </label><br>
  
      <label>Amount: <input type="number" name="amount" step="0.01" required></label><br>
      <label>Note: <input type="text" name="note"></label><br>
  
      <button type="submit">Submit Expense</button>
    </form>
  </div>
  <h1 id="expense-summary"></h1>
  

  <script>
    const CLIENT_ID = '1037687338882-efhp3h8f8fe6pkri1jh1nvavp0ja9hei.apps.googleusercontent.com'; // Paste your client ID
    const SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/drive.file';

    const currencies = ['IDR','USD']; //add more currencies here
    const categories = ['Insurance','School','Dorm','Food','Internet','Transportation','Entertainment','Groceries','Others'];

    let tokenClient;
    let gapiInited = false;
    let gisInited = false;
    let sheetID1;

    function gapiLoaded() {
      gapi.load('client', initializeGapiClient);
    }

    async function initializeGapiClient() {
      await gapi.client.init({
        discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
      });
      gapiInited = true;
      await gapi.client.load('drive', 'v3');
    }

    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: '', // we set this when requesting access
      });
      gisInited = true;
    }


    document.getElementById("add-expense-form").addEventListener("submit", async function(e) {
      e.preventDefault();
      const form = e.target;

      const row = [
        form.date.value,
        form.name.value,
        form.category.value,
        form.currency.value,
        parseFloat(form.amount.value), // Ensuring numeric value
        form.note.value
      ];

      try {
        const nextRow = await getNextEmptyRow(sheetID1); // Determine next available row
        const range = `Sheet1!B${nextRow}:G${nextRow}`;  // Target B to G in that row

        await gapi.client.sheets.spreadsheets.values.update({
          spreadsheetId: sheetID1,
          range: range,
          valueInputOption: "USER_ENTERED",
          resource: {
            values: [row]
          }
        });

        alert("✅ Expense added successfully!");
        form.reset();
        await updateExpenseSummary();
      } catch (error) {
        console.error("❌ Failed to add expense:", error);
        alert("❌ Failed to add expense. Check the console for details.");
      }
    });



    async function getNextEmptyRow(spreadsheetId) {
      const response = await gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: spreadsheetId,
        range: 'Sheet1!B3:B', // Check from row 3 downward
      });

      const rows = response.result.values || [];
      return rows.length + 3; // Account for the starting row index (B3 → row 3)
    }


    async function updateExpenseSummary() {
      const response = await gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: sheetID1,
        range: "Sheet1!E3:F", 
      });

      const rows = response.result.values || [];
      let totals = {
        CAD: 0,
        IDR: 0
      };

      for (const [currency, amount] of rows) {
        const numericAmount = parseFloat(amount);
        if (!isNaN(numericAmount)) {
          if (currency === "CAD") {
            totals.CAD += numericAmount;
          } else if (currency === "IDR") {
            totals.IDR += numericAmount;
          }
        }
      }

      document.getElementById("expense-summary").innerHTML = `
        <strong>Total Expenses</strong><br>
        CAD: $${totals.CAD.toLocaleString("en-US")}<br>
        IDR: Rp ${totals.IDR.toLocaleString("en-US")}
      `;
    }



    function handleAuthClick() {
      tokenClient.callback = async (resp) => {
        if (resp.error) throw resp;

        //GETTING USER EMAIL
        const accessToken = gapi.client.getToken().access_token;
        const userInfo = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
            headers: {
                Authorization: `Bearer ${accessToken}`, // Pass access token in Authorization header
            },
        }).then(res => res.json());

        console.log("Sign in as: ", userInfo.email);
        

      


        //FINDING FOLDER IN GOOGLE DRIVE
        await gapi.client.load('drive','v3');
        const foundFolder = await findFolderByName('Expense Tracker');
        if(foundFolder){
            console.log('Found Folder:', foundFolder);
            let sheetFound = false;
            if (foundFolder.length > 0) {
              for (const folder of foundFolder) {
                const sheets = await findFileWithinFolder('Expense Tracker Sheet', folder.id);
                if (sheets){
                  console.log('Found Sheet:', sheets);
                  sheetFound = true;
                  const sheet = sheets[0];
                  document.getElementById('output').innerHTML =
                    `✅ Sheet Found: <a href="${sheet.webViewLink}" target="_blank">${sheet.webViewLink}</a>`;
                  document.getElementById('expense-form').style.display = 'block';
                  document.getElementById('expense-summary').style.display = 'block';
                  sheetID1 = sheet.id;
                  break;
                  break;
                }
              }
              if (!sheetFound){
                console.log('Sheet Not Found');
                const createSheet = await createSheetInFolder(foundFolder[0].id);
              }
            }
            updateExpenseSummary();
        }else{
            //Making new folder
            const newFolder = await createFolder();
            const newSheet = await createSheetInFolder(newFolder.id);
        }
      };
      tokenClient.requestAccessToken({ prompt: 'consent' });
    }

    async function findFileWithinFolder(filename, folderID) {
      const response = await gapi.client.drive.files.list({
        q: `name = '${filename}' and mimeType = 'application/vnd.google-apps.spreadsheet' and '${folderID}' in parents and trashed = false`,
        fields: 'files(id, name, webViewLink)'
      });

      const files = response.result.files;
      if (files && files.length > 0){
        console.log('FILES:',files);
        return files;
      } else {
        console.log('Sheet Not Found');
        return null;
      }
    }

    async function findFileByName(filename) {
        const response = await gapi.client.drive.files.list({
            q: `name = '${filename}' and trashed = false`,
            fields: 'files(id, name, webViewLink)'
        });

        const files = response.result.files;
        if (files && files.length > 0) {
            return files[0]; // return the first match
        } else {
            console.log('No file found with name:', filename);
            return null;
        }
    }

    async function findFolderByName(foldername) {
        const response = await gapi.client.drive.files.list({
            q: `name = '${foldername}' and mimeType = 'application/vnd.google-apps.folder' and trashed = false`,
            fields: 'files(id, name, webViewLink)'
        });

        const folders = response.result.files;
        if (folders && folders.length > 0){
            return folders;
        } else {
            console.log('No folder found with name:', foldername);
            return null;
        }
    }

    async function createFolder() {
        const response = await gapi.client.drive.files.create({
            resource: {
                name: 'Expense Tracker',
                mimeType: 'application/vnd.google-apps.folder'
            },
            fields: 'id, name, webViewLink'
        });
        const folder = response.result;
        console.log('Folder ID: ', folder.id);
        return folder;
    }

    async function createSheetInFolder(folderID) {
      const fileMetadata = {
        name: 'Expense Tracker Sheet',
        mimeType: 'application/vnd.google-apps.spreadsheet',
        parents: [folderID]
      };

      const response = await gapi.client.drive.files.create({
        resource: fileMetadata,
        fields: 'id, name, webViewLink'
      });

      console.log('Sheet Created:',response.result);


      const spreadsheetId = response.result.id;
      const sheetUrl = response.result.webViewLink;

      // Step 1: Write data
      await gapi.client.sheets.spreadsheets.values.update({
          spreadsheetId: spreadsheetId,
          range: 'Sheet1!B2:G2',
          valueInputOption: 'RAW',
          resource: {
          values: [
              ['Date', 'Name', 'Category','Currency','Amount','Note']
          ]
          }
      });

      // Step 2: Apply formatting (merge A1:C1, center text, light blue background)
      await gapi.client.sheets.spreadsheets.batchUpdate({
          spreadsheetId: spreadsheetId,
          resource: {
          requests: [
            {
              repeatCell: {
                range: {
                  sheetId: 0,
                  startRowIndex: 1,
                  endRowIndex: 2,
                  startColumnIndex: 1,
                  endColumnIndex: 7
                },
                cell: {
                  userEnteredFormat: {
                    backgroundColor: { red: 1, green: 0.74, blue: 0 }, 
                    horizontalAlignment: "CENTER",
                    textFormat: { bold: true }
                  }
                },
                fields: "userEnteredFormat(backgroundColor,textFormat,horizontalAlignment)"
              }
            },
            {
            updateDimensionProperties: {
                range: {
                sheetId: 0, // your sheet ID
                dimension: "COLUMNS",
                startIndex: 1, // column A
                endIndex: 7   
                },
                properties: {
                pixelSize: 200 // set width in pixels
                },
                fields: "pixelSize"
            }
            },
            {
              updateBorders: {
                range: {
                  sheetId: 0,
                  startRowIndex: 1,
                  endRowIndex: 2,
                  startColumnIndex: 1,
                  endColumnIndex: 7
                },
                top: {
                  style: "SOLID",
                  width: 2,
                  color: { red: 0, green: 0, blue: 0 }
                },
                bottom: {
                  style: "SOLID",
                  width: 2,
                  color: { red: 0, green: 0, blue: 0 }
                },
                left: {
                  style: "SOLID",
                  width: 2,
                  color: { red: 0, green: 0, blue: 0 }
                },
                right: {
                  style: "SOLID",
                  width: 2,
                  color: { red: 0, green: 0, blue: 0 }
                },
                innerHorizontal: {
                  style: "SOLID",
                  width: 2,
                  color: { red: 0, green: 0, blue: 0 }
                },
                innerVertical: {
                  style: "SOLID",
                  width: 2,
                  color: { red: 0, green: 0, blue: 0 }
                }
              }
            }
          ]
          }
      });

      document.getElementById('output').innerHTML =
          `✅ Sheet Created, Data Added & Formatted: <a href="${sheetUrl}" target="_blank">${sheetUrl}</a>`;
      document.getElementById('expense-form').style.display = 'block';
      document.getElementById('expense-summary').style.display = 'block';
      sheetID1 = spreadsheetId;
    }

    async function createSheet() {
        const createResponse = await gapi.client.sheets.spreadsheets.create({
            properties: {
            title: 'Expense Tracker Sheet'
            }
        });

        const spreadsheetId = createResponse.result.spreadsheetId;
        const sheetUrl = createResponse.result.spreadsheetUrl;

        // Step 1: Write data
        await gapi.client.sheets.spreadsheets.values.update({
            spreadsheetId: spreadsheetId,
            range: 'Sheet1!A1:C3',
            valueInputOption: 'RAW',
            resource: {
            values: [
                ['Name', 'Email', 'Amount'],
                ['Alice', 'alice@example.com', '42'],
                ['Budi' , 'budi@example.com', '30']
            ]
            }
        });

        // Step 2: Apply formatting (merge A1:C1, center text, light blue background)
        await gapi.client.sheets.spreadsheets.batchUpdate({
            spreadsheetId: spreadsheetId,
            resource: {
            requests: [
                {
                mergeCells: {
                    range: {
                    sheetId: 0, // Assumes "Sheet1"
                    startRowIndex: 0,
                    endRowIndex: 1,
                    startColumnIndex: 0,
                    endColumnIndex: 3
                    },
                    mergeType: "MERGE_ALL"
                }
                },
                {
                repeatCell: {
                    range: {
                    sheetId: 0,
                    startRowIndex: 0,
                    endRowIndex: 1,
                    startColumnIndex: 0,
                    endColumnIndex: 3
                    },
                    cell: {
                    userEnteredFormat: {
                        backgroundColor: { red: 0.8, green: 0.9, blue: 1.0 },
                        horizontalAlignment: "CENTER",
                        textFormat: { bold: true }
                    }
                    },
                    fields: "userEnteredFormat(backgroundColor,textFormat,horizontalAlignment)"
                }
                },
                {
                updateDimensionProperties: {
                    range: {
                    sheetId: 0, // your sheet ID
                    dimension: "COLUMNS",
                    startIndex: 0, // column A
                    endIndex: 3    // up to but not including column D
                    },
                    properties: {
                    pixelSize: 200 // set width in pixels
                    },
                    fields: "pixelSize"
                }
                }
            ]
            }
        });

        document.getElementById('output').innerHTML =
            `✅ Sheet Created, Data Added & Formatted: <a href="${sheetUrl}" target="_blank">${sheetUrl}</a>`;
    }



    window.onload = () => {
      gapiLoaded();
      gisLoaded();
    };
  </script>
</body>
</html>
