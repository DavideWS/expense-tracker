<!DOCTYPE html>
<html>
<head>
  <title>Create Google Sheet</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
  <h1>Create a Google Sheet</h1>
  <button onclick="handleAuthClick()">Sign In & Create Sheet</button>
  <div id="output"></div>

  <script>
    const CLIENT_ID = '1037687338882-efhp3h8f8fe6pkri1jh1nvavp0ja9hei.apps.googleusercontent.com'; // Paste your client ID
    const SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/drive.file';

    let tokenClient;
    let gapiInited = false;
    let gisInited = false;

    function gapiLoaded() {
      gapi.load('client', initializeGapiClient);
    }

    async function initializeGapiClient() {
      await gapi.client.init({
        discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
      });
      gapiInited = true;
      await gapi.client.load('drive', 'v3');
    }

    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: '', // we set this when requesting access
      });
      gisInited = true;
    }

    function handleAuthClick() {
      tokenClient.callback = async (resp) => {
        if (resp.error) throw resp;

        //GETTING USER EMAIL
        const accessToken = gapi.client.getToken().access_token;
        const userInfo = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
            headers: {
                Authorization: `Bearer ${accessToken}`, // Pass access token in Authorization header
            },
        }).then(res => res.json());

        console.log("Sign in as: ", userInfo.email);
        




        //FINDING FOLDER IN GOOGLE DRIVE
        await gapi.client.load('drive','v3');
        const foundFolder = await findFolderByName('Expense Tracker');
        if(foundFolder){
            console.log('Found Folder:', foundFolder);
            let sheetFound = false;
            if (foundFolder.length > 0) {
              for (const folder of foundFolder) {
                const sheets = await findFileWithinFolder('Expense Tracker Sheet', folder.id);
                if (sheets){
                  console.log('Found Sheet:', sheets);
                  sheetFound = true;
                  const sheet = sheets[0];
                  document.getElementById('output').innerHTML =
                    `✅ Sheet Found: <a href="${sheet.webViewLink}" target="_blank">${sheet.webViewLink}</a>`;
                  break;
                  break;
                }
              }
              if (!sheetFound){
                console.log('Sheet Not Found');
                const createSheet = await createSheetInFolder(foundFolder[0].id);
              }
            }
        }else{
            //Making new folder
            const newFolder = await createFolder();
            const newSheet = await createSheetInFolder(newFolder.id);
        }
      };
      tokenClient.requestAccessToken({ prompt: 'consent' });
    }

    async function findFileWithinFolder(filename, folderID) {
      const response = await gapi.client.drive.files.list({
        q: `name = '${filename}' and mimeType = 'application/vnd.google-apps.spreadsheet' and '${folderID}' in parents and trashed = false`,
        fields: 'files(id, name, webViewLink)'
      });

      const files = response.result.files;
      if (files && files.length > 0){
        console.log('FILES:',files);
        return files;
      } else {
        console.log('Sheet Not Found');
        return null;
      }
    }

    async function findFileByName(filename) {
        const response = await gapi.client.drive.files.list({
            q: `name = '${filename}' and trashed = false`,
            fields: 'files(id, name, webViewLink)'
        });

        const files = response.result.files;
        if (files && files.length > 0) {
            return files[0]; // return the first match
        } else {
            console.log('No file found with name:', filename);
            return null;
        }
    }

    async function findFolderByName(foldername) {
        const response = await gapi.client.drive.files.list({
            q: `name = '${foldername}' and mimeType = 'application/vnd.google-apps.folder' and trashed = false`,
            fields: 'files(id, name, webViewLink)'
        });

        const folders = response.result.files;
        if (folders && folders.length > 0){
            return folders;
        } else {
            console.log('No folder found with name:', foldername);
            return null;
        }
    }

    async function createFolder() {
        const response = await gapi.client.drive.files.create({
            resource: {
                name: 'Expense Tracker',
                mimeType: 'application/vnd.google-apps.folder'
            },
            fields: 'id, name, webViewLink'
        });
        const folder = response.result;
        console.log('Folder ID: ', folder.id);
        return folder;
    }

    async function createSheetInFolder(folderID) {
      const fileMetadata = {
        name: 'Expense Tracker Sheet',
        mimeType: 'application/vnd.google-apps.spreadsheet',
        parents: [folderID]
      };

      const response = await gapi.client.drive.files.create({
        resource: fileMetadata,
        fields: 'id, name, webViewLink'
      });

      console.log('Sheet Created:',response.result);


      const spreadsheetId = response.result.id;
      const sheetUrl = response.result.webViewLink;

      // Step 1: Write data
      await gapi.client.sheets.spreadsheets.values.update({
          spreadsheetId: spreadsheetId,
          range: 'Sheet1!B2:F2',
          valueInputOption: 'RAW',
          resource: {
          values: [
              ['Date', 'Name', 'Category','Amount','Note']
          ]
          }
      });

      // Step 2: Apply formatting (merge A1:C1, center text, light blue background)
      await gapi.client.sheets.spreadsheets.batchUpdate({
          spreadsheetId: spreadsheetId,
          resource: {
          requests: [
            {
              repeatCell: {
                range: {
                  sheetId: 0,
                  startRowIndex: 1,
                  endRowIndex: 2,
                  startColumnIndex: 1,
                  endColumnIndex: 6
                },
                cell: {
                  userEnteredFormat: {
                    backgroundColor: { red: 1, green: 0.74, blue: 0 }, 
                    horizontalAlignment: "CENTER",
                    textFormat: { bold: true }
                  }
                },
                fields: "userEnteredFormat(backgroundColor,textFormat,horizontalAlignment)"
              }
            },
            {
            updateDimensionProperties: {
                range: {
                sheetId: 0, // your sheet ID
                dimension: "COLUMNS",
                startIndex: 1, // column A
                endIndex: 6    // up to but not including column D
                },
                properties: {
                pixelSize: 200 // set width in pixels
                },
                fields: "pixelSize"
            }
            },
            {
              updateBorders: {
                range: {
                  sheetId: 0,
                  startRowIndex: 1,
                  endRowIndex: 2,
                  startColumnIndex: 1,
                  endColumnIndex: 6
                },
                top: {
                  style: "SOLID",
                  width: 2,
                  color: { red: 0, green: 0, blue: 0 }
                },
                bottom: {
                  style: "SOLID",
                  width: 2,
                  color: { red: 0, green: 0, blue: 0 }
                },
                left: {
                  style: "SOLID",
                  width: 2,
                  color: { red: 0, green: 0, blue: 0 }
                },
                right: {
                  style: "SOLID",
                  width: 2,
                  color: { red: 0, green: 0, blue: 0 }
                },
                innerHorizontal: {
                  style: "SOLID",
                  width: 2,
                  color: { red: 0, green: 0, blue: 0 }
                },
                innerVertical: {
                  style: "SOLID",
                  width: 2,
                  color: { red: 0, green: 0, blue: 0 }
                }
              }
            }
          ]
          }
      });

      document.getElementById('output').innerHTML =
          `✅ Sheet Created, Data Added & Formatted: <a href="${sheetUrl}" target="_blank">${sheetUrl}</a>`;
    }

    async function createSheet() {
        const createResponse = await gapi.client.sheets.spreadsheets.create({
            properties: {
            title: 'Expense Tracker Sheet'
            }
        });

        const spreadsheetId = createResponse.result.spreadsheetId;
        const sheetUrl = createResponse.result.spreadsheetUrl;

        // Step 1: Write data
        await gapi.client.sheets.spreadsheets.values.update({
            spreadsheetId: spreadsheetId,
            range: 'Sheet1!A1:C3',
            valueInputOption: 'RAW',
            resource: {
            values: [
                ['Name', 'Email', 'Amount'],
                ['Alice', 'alice@example.com', '42'],
                ['Budi' , 'budi@example.com', '30']
            ]
            }
        });

        // Step 2: Apply formatting (merge A1:C1, center text, light blue background)
        await gapi.client.sheets.spreadsheets.batchUpdate({
            spreadsheetId: spreadsheetId,
            resource: {
            requests: [
                {
                mergeCells: {
                    range: {
                    sheetId: 0, // Assumes "Sheet1"
                    startRowIndex: 0,
                    endRowIndex: 1,
                    startColumnIndex: 0,
                    endColumnIndex: 3
                    },
                    mergeType: "MERGE_ALL"
                }
                },
                {
                repeatCell: {
                    range: {
                    sheetId: 0,
                    startRowIndex: 0,
                    endRowIndex: 1,
                    startColumnIndex: 0,
                    endColumnIndex: 3
                    },
                    cell: {
                    userEnteredFormat: {
                        backgroundColor: { red: 0.8, green: 0.9, blue: 1.0 },
                        horizontalAlignment: "CENTER",
                        textFormat: { bold: true }
                    }
                    },
                    fields: "userEnteredFormat(backgroundColor,textFormat,horizontalAlignment)"
                }
                },
                {
                updateDimensionProperties: {
                    range: {
                    sheetId: 0, // your sheet ID
                    dimension: "COLUMNS",
                    startIndex: 0, // column A
                    endIndex: 3    // up to but not including column D
                    },
                    properties: {
                    pixelSize: 200 // set width in pixels
                    },
                    fields: "pixelSize"
                }
                }
            ]
            }
        });

        document.getElementById('output').innerHTML =
            `✅ Sheet Created, Data Added & Formatted: <a href="${sheetUrl}" target="_blank">${sheetUrl}</a>`;
    }



    window.onload = () => {
      gapiLoaded();
      gisLoaded();
    };
  </script>
</body>
</html>
